trigger: none
pr: none

parameters:
  - name: mode
    type: string
    displayName: "Mode"
    default: "audit"
    values:
      - audit
      - dry-run
      - apply
      - rollback

  - name: targetRepoUrl
    type: string
    displayName: "Target GitHub repo HTTPS URL"
    default: ""

  - name: targetBranches
    type: string
    displayName: "Branches (comma-separated)"
    default: "main"

  - name: outputCsvName
    type: string
    displayName: "Output CSV filename"
    default: "synopsys_blackduck_migration.csv"

pool:
  vmImage: ubuntu-latest

steps:
  - checkout: self
    fetchDepth: 1

  - bash: |
      set -euo pipefail
      cd "$(Build.SourcesDirectory)"

      MODE="${{ parameters.mode }}"
      TARGET_REPO_URL="${{ parameters.targetRepoUrl }}"
      TARGET_BRANCHES="${{ parameters.targetBranches }}"
      OUT_CSV="${{ parameters.outputCsvName }}"

      if [[ -z "$TARGET_REPO_URL" ]]; then
        echo "[ERROR] targetRepoUrl is empty"
        exit 1
      fi

      echo "Mode           : $MODE"
      echo "Target Repo    : $TARGET_REPO_URL"
      echo "Branches       : $TARGET_BRANCHES"
      echo "CSV            : $OUT_CSV"
      echo

      SCRIPT="./synopsys_to_blackduck_migrate_v6_7.sh"
      chmod +x "$SCRIPT"

      rm -f "$OUT_CSV"

      IFS=',' read -r -a BRANCHES <<< "$TARGET_BRANCHES"

      VALID_BRANCHES=()
      for BR in "${BRANCHES[@]}"; do
        BR="$(echo "$BR" | xargs)"
        [[ -z "$BR" ]] && continue

        if git ls-remote --heads "$TARGET_REPO_URL" "$BR" | grep -q "refs/heads/$BR"; then
          VALID_BRANCHES+=("$BR")
        else
          echo "[WARN] Branch not found: $BR"
        fi
      done

      if [[ ${#VALID_BRANCHES[@]} -eq 0 ]]; then
        echo "[ERROR] No valid branches"
        exit 1
      fi

      AUTH_URL="$TARGET_REPO_URL"
      if [[ -n "${GITHUB_TOKEN:-}" ]]; then
        AUTH_URL="$(echo "$TARGET_REPO_URL" | sed -E "s#^https://github.com/#https://x-access-token:${GITHUB_TOKEN}@github.com/#")"
      fi

      git config --global user.email "azure-pipelines@local"
      git config --global user.name "azure-pipelines"

      for BR in "${VALID_BRANCHES[@]}"; do
        echo "===================================================="
        echo "Processing branch: $BR"
        echo "===================================================="

        rm -rf target-repo
        git clone --single-branch --branch "$BR" "$AUTH_URL" target-repo

        export ROOT="target-repo"
        export MODE="$MODE"
        export OUT_CSV="$OUT_CSV"

        if [[ "$MODE" == "apply" || "$MODE" == "rollback" ]]; then
          export COMMIT=1
          export PUSH=1
        else
          export COMMIT=0
          export PUSH=0
        fi

        bash "$SCRIPT"
        echo
      done

      echo "===================================================="
      echo "CSV preview:"
      echo "===================================================="
      head -n 30 "$OUT_CSV" || true
    displayName: "Run Synopsys â†’ Black Duck migration (v6_7)"

  - task: PublishPipelineArtifact@1
    condition: always()
    inputs:
      targetPath: '$(Build.SourcesDirectory)/${{ parameters.outputCsvName }}'
      artifact: 'synopsys-blackduck-migration-report'
      publishLocation: 'pipeline'
    displayName: "Publish migration CSV"
